#### 背景介绍

一般互联网公司中, 测试环境和预发环境都是只对内部员工访问使用的, 在医药魔方, 因为有4个办公室, 而且之前没有VPN, 也不是所有办公室都有固定IP, 所以为了能让分布在各个办公室的技术同学都可以访问, 测试和预发环境放到了公网上, 这是非常危险的, 因为预发环境跟生产环境的数据是一样的,  直接暴露在公网有极大的安全隐患; 所以等固定IP和VPN项目落地以后, 就需要把测试和预发环境放到内网环境


操作方式就是通过在测试和预发机器所在的安全组中只对办公室出口IP开放, 操作起来倒是很简单, 但是第二天上班的时候, 有同事反馈旧版预发环境的资源全部都502了, 而且链接都是CDN的, 很明显是CDN出问题了, 但是具体是什么原因, 我也是一头雾水
![企业微信截图_1691388843965](https://github.com/wufeiqun/blog/assets/7486508/532179cc-c043-4ea8-87b3-0e857d3fab8f)

这个时候其实我是又安静又有点恐慌, 安静是因为这是预发环境, 不用想用户的使用, 慢慢排查就行, 恐慌是我对CDN知识掌握的一般, 如果生产遇到问题了, 我根本没有办法第一时间解决的, 所以趁这个机会, 要把CDN的基本逻辑搞清楚.

#### 问题分析

问题的原因是我的思维中认为预发环境只有内部访问, 忘了如果前端项目使用CDN, 并且源站放在了自己的服务器上, 那么CDN会定期回源访问的, 也就是阿里云的CDN服务会访问预发环境的源站静态资源, 而老的预发环境的源站采用的是源站就是自建服务器上的服务, 调整安全组就限制公网访问, 自然而然CDN也访问不了了

那为什么新的预发CDN没有这个问题呢, 因为新的预发源站的静态资源放到了阿里云的OSS, 也就是阿里云的CDN系统会直接访问阿里云上面的OSS存储, 不会访问公司自建的系统, 所以没有这个问题, 这里也解答了我多年的疑惑, 我一直搞不明白阿里云的OSS是怎么做到又能是OSS存储, 又可以是CDN, 原来他们是两个不同的产品, 只是两个产品之间可以相互配合.OSS可以作为CDN的源站数据存放的位置.

#### 后记备忘

* CDN就是内容分发系统, 为了让用户就近访问, 提高静态资源的访问速度, 所以就会有缓存刷新的问题, 一般的方式是前端每次上线构建的时候, 静态资源的名字都不一样, 也就是文件名字中加入了MD5, 这样每次发布, 用户调用的都是最新的文件, 就不需要刷新CDN缓存这么一说了

