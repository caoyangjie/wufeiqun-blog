#### 背景介绍

一般企业中使用容器化基本上都是使用的云厂商提供的服务, 而不是自己搭建, 自己搭建维护成本非常高, 在使用阿里云ACK的时候, 也会有一些小细节需要注意, 不然也会有问题, 这里总结以下.


#### 问题记录

* ECS机型对磁盘的支持

阿里云的ECS对磁盘的支持是有限制的, 一般比较新的服务器不太会支持传统的`高效云盘`, 只支持SSD, 所以如果选择了比较新的服务器型号, 但是POD如果要使用普通的`高效云盘`, 就会有问题, 创建不出POD.

比如如下的两个相同系列的型号, 新型号不支持`高效云盘`:

<img width="1256" alt="image" src="https://github.com/wufeiqun/blog/assets/7486508/cca93bd1-4557-4c94-af4c-7589fffe377b">
<img width="1444" alt="image" src="https://github.com/wufeiqun/blog/assets/7486508/6c40fcff-9c3e-45d9-9049-23cc12dbc4c3">



#### PV可用区的问题

在使用ACK部署有状态的服务的时候, 如果使用到了存储, 一般是使用动态绑定的方式, 动态绑定的方式可以根据自己的需求创建合适大小的PVC, 进而自动创建相应的PV和相应型号的云盘, 这里有一个细节就是创建好的云盘只能绑定到同一个可用区的ECS, 所以如果替换k8s节点的时候, 想要复用已有的PVC/PV资源就需要创建相同可用区的ECS, 不然不能复用, 只能创建新的磁盘. 而新加入一个节点, 让通过驱逐另一个可用区上的POD到该可用区, 如果POD绑定了PVC, 那就是属于要复用的这个case.

#### 增加减少ACK节点的时候不要忘记相关的域名解析

很多时候, 我们使用`service`的类型为`nodeport`, 然后通过SLB或者域名直到所有的节点上, 当节点变动的时候一定要注意有没有域名指向该节点, 有没有负载均衡/Nginx引用该节点, 不然改动就会出问题.

#### 节点标签

增加/减少节点的时候, 要注意标签, 不然会出现加上节点也调度不到上面的情况.

#### CLB可以直接代理kubernetes里面的服务

`service`采用`nodeport`的方式, CLB后面添加虚拟服务器组, 将所有node节点加进去, 就可以了, 注意node节点变更的时候要同步修改CLB即可. 

#### k8s的PV/PVC等要使用按量付费

默认情况下, 通过yaml创建的磁盘都是按量付费的, 我遇到过这样的一个情况, 就是k8s的节点都是包年包月的, 阿里云账号上的费用有时候充值比较慢的话会衔接不上, 导致账号上没钱了, 因为有一些资源是按量收费的, 比如流量等, 所以账号上不能没钱, 正好看到k8s的节点刚充值完, 于是就把这些几个节点改成按量付费, 这样可以退回一部分费用, 等续费以后再改成包年包月, 结果改成包年包月的时候, 磁盘也都改成了包年包月, 结果等k8s里面的服务扩容磁盘的时候遇到问题了, 就是新建了一批次的磁盘, 而没有使用以前的磁盘, 因为包年包月的磁盘不能卸载/挂载, 所以会出现问题. 以后就不要动k8s的磁盘付费类型了.
