upstream serviceA{
    server k8s-node-inner.baidu.com:32644;
}

server {
    # 开启HTTPS和HTTP2
    listen 443 ssl http2;
    server_name www.baidu.com;
    ssl_certificate /usr/local/nginx/cert/baidu.com/baidu.com.pem;
    ssl_certificate_key /usr/local/nginx/cert/baidu.com/baidu.com.key;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:100m;
    ssl_session_tickets off;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305;
    ssl_prefer_server_ciphers off;
    access_log /usr/local/nginx/logs/www.baidu.com.access.log main;
    location ^~ /actuator {
        return 403;
    }
    location / {
        proxy_pass http://www.pharmcube.com;
        if ($http_cookie ~* "grey_web_site=true" ) {
            proxy_pass http://k8s-node-inner.drugcube.com:38433;
        }
        #proxy_http_version 1.1;
        proxy_set_header Connection "";
        #proxy_cache my-cache;
        #proxy_cache_valid 200;
        #proxy_redirect off;
        proxy_redirect http:// https://;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header REMOTE-HOST $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        client_max_body_size 5m;
        proxy_connect_timeout 30;
        proxy_send_timeout 30;
        proxy_read_timeout 60;
        proxy_buffer_size 64k;
        proxy_buffers 4 64k;
        proxy_busy_buffers_size 128k;
        proxy_temp_file_write_size 64k;
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_404;
        proxy_max_temp_file_size 0;
        add_header Access-Control-Allow-Origin $http_origin;
        add_header Access-Control-Allow-Headers *;
        add_header Access-Control-Allow-Headers lang;
        add_header Access-Control-Allow-Headers content-type;
        add_header Access-Control-Allow-Headers ajax;
        add_header Access-Control-Allow-Headers x-requested-with;
        add_header Access-Control-Allow-Methods *;
        add_header Access-Control-Allow-Credentials true;
        #OPTIONS 直接返回204
        if ($request_method = 'OPTIONS') {
           return 204;
        }
    }
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root html;
    }
    location =/authority/login {
        proxy_pass http://www.pharmcube.com;
    }
    location =/ {
        proxy_pass http://k8s-node-inner.drugcube.com:31628;
    }
    # 移动端
    location =/m {
        proxy_pass http://k8s-node-inner.drugcube.com:31628;
    }
    location /en {
        proxy_pass http://k8s-node-inner.drugcube.com:31628;
    }
    location /auth {
        alias /cicd/app/fe-pharmcube-product/product;
        index index.html;
        try_files $uri $uri/ /auth/index.html;
    }
    location ^~ /index {
        proxy_pass http://k8s-node-inner.drugcube.com:31628;
    }
    location  /static/ {
        proxy_pass http://k8s-node-inner.drugcube.com:31628;
    }
    location =/_payload.json {
        proxy_pass http://k8s-node-inner.drugcube.com:31628;
    }
    location = /sitemap.xml {
        proxy_pass http://k8s-node-inner.drugcube.com:31628;
    }
    location = /robots.txt {
        proxy_pass http://k8s-node-inner.drugcube.com:31628;
    }
    location ^~/product {
        proxy_pass http://k8s-node-inner.drugcube.com:31628;
    }
    location /__sitemap__/style.xsl {
        proxy_pass http://k8s-node-inner.drugcube.com:31628;
    }
    location ^~/project {
        #alias /opt/www/project;
        alias /cicd/app/fe-pharmcube-product/product;
        index index.html;
        if ($request_filename ~* .*\.(?:htm|html)$) {
            add_header Cache-Control "no-store";
        }
        try_files $uri $uri/ /project/index.html;
    }
    location ^~/newsLibrary {
        #alias /opt/www/newsLibrary;
        alias /cicd/app/fe-pharmcube-newsLibrary/newsLibrary;
        index index.html;
        if ($request_filename ~* .*\.(?:htm|html)$) {
            add_header Cache-Control "no-store";
        }
        try_files $uri $uri/ /newsLibrary/index.html;
    }
    location ^~/newsLibraryWeb {
        #alias /opt/www/newsLibraryWeb;
        alias /cicd/app/fe-pharmcube-newsLibraryWeb/newsLibraryWeb;
        index index.html;
        if ($request_filename ~* .*\.(?:htm|html)$) {
            add_header Cache-Control "no-store";
        }
        try_files $uri $uri/ /newsLibraryWeb/index.html;
    }
    location ^~/database/BioNewsWiser {
        alias /opt/www/database/BioNewsWiser;
        index index.html;
        if ($request_filename ~* .*\.(?:htm|html)$) {
            add_header Cache-Control "no-store";
        }
        try_files $uri $uri/ /database/BioNewsWiser/index.html;
    }

    # temporarily add this redirection to prevent error page when access www.pharmcube.com/report/index
    # remove the following strategy when solve the problem immediately.
    # by WuDi 20230312 16:00
    location ^~/report/index {
        return 302 https://www.pharmcube.com/product/report/index;
    }
    add_header Content-Security-Policy upgrade-insecure-requests;
}

server {
    listen 80;
    server_name www.pharmcube.com pharmcube.com yiyaomofang.com www.yiyaomofang.com pharmcube.pro www.pharmcube.pro nextpharma.pro www.nextpharma.pro pharmago.pro www.pharmago.pro
investgo.pro www.investgo.pro biopharmcube.com www.biopharmcube.com biochina.site yymf.com.cn www.yymf.com.cn drugcube.com  medcube.cn www.medcube.cn medicube.cn www.medicube.cn;
    return 301 https://$server_name$request_uri;
}
